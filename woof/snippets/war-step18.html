<head>
<script src="https://cdn.rawgit.com/stevekrouse/WoofJS/a1a059a9/dist/woof.js"></script>
<title>War Step 18</title>
</head>
<body>
<script>

var goToGround = (sprite) => {
  if (sprite.radius)
    sprite.y = groundLine + sprite.radius;
  else
    sprite.y = groundLine + sprite.height / 2;
};

var setYTarget = () => {
  if (mouseY > pMouseY) 
    yTarget -= (mouseY - pMouseY) * 5;
  else if (mouseY < pMouseY) 
    yTarget += (pMouseY - mouseY) * 5;
};

var makeContact = (player) => {
  return player.ball.x > maxX || player.ball.y > maxY || player.ball.x < minX || player.ball.y <= groundLine + 5 || player.ball.touching(middle) || player.ball.touching(player.enemy.shield) || player.ball.touching(player.enemy.shooter);
};

var setBall = (player) => {
  player.ball.x = player.shooter.x;
  player.ball.y = player.shooter.y;
  player.ball.angle = player.shooter.angle;
  player.ball.move(35);
  player.ball.show();
};

var shoot = (player) => {
  player.ball.move(power / 20);
  player.ball.y -= gravity;
  gravity += 0.15;
};

var finishTurn = (player) => {
  player.ball.hide();
  gravity = 0.15;
  player1.turn = !player1.turn;
  player2.turn = !player2.turn;
};

setBackdropURL("../images/war-backdrop.png");

var groundLine = (minY + height / 5);

var middle = new Rectangle({
  color: "#223388",
  width: width / 3,
  height: height / 4,
  y: (groundLine + height / 8) - 1
});

var shooterP1 = new Image({
  url: "../images/war-cannon1.png",
  width: 50,
  height: 20,
  x: minX + 40
});
goToGround(shooterP1);

var shieldP1 = new Circle({
  brightness: 50,
  color: "#DD3513",
  radius: 100,
  x: shooterP1.x,
  y: shooterP1.y - 20
});

var ballP1 = new Circle({
  color: "#DD3513",
  radius: 10,
  x: minX + 50,
  showing: false
});

var player1 = {
  shooter: shooterP1,
  shield: shieldP1,
  ball: ballP1,
  turn: true
};

var ballP2 = new Circle({
  color: "#009940",
  radius: 10,
  showing: false
});

var shooterP2 = new Image({
  url: "../images/war-cannon2.png",
  width: 50,
  height: 20,
  x: maxX - 40,
  angle: LEFT
});
goToGround(shooterP2);

var shieldP2 = new Circle({
  brightness: 30,
  color: "#3CCC3C",
  radius: 100,
  x: shooterP2.x,
  y: shooterP2.y - 20
});

var player2 = {
  shooter: shooterP2,
  ball: ballP2,
  shield: shieldP2,
  turn: false
};

player1.enemy = player2;
player2.enemy = player1;

var bottom = new Rectangle({
  color: "#223388",
  width: width,
  height: height / 5,
  y: groundLine - height / 10
});

var powerCircle = new Circle({
  color: "yellow",
  radius: 0,
  x: shooterP1.x,
  y: shooterP1.y,
  brightness: 10
});

var xStart = 0;
var power = 0;
var yTarget = groundLine + 100;
var gravity = 0.15;

onMouseDown(() => {
  xStart = mouseX;
  yTarget = groundLine + 50;
  if (player1.turn)
    player1.shooter.pointTowards(maxX, yTarget);
  else if (player2.turn)
    player2.shooter.pointTowards(minX, yTarget);
});

onMouseMove(() => {
  if (mouseDown) {
    setYTarget();
    if (player1.turn) {
      shooterP1.pointTowards(maxX, yTarget);
      powerCircle.x = player1.shooter.x;
    }
    else if (player2.turn) {
      shooterP2.pointTowards(minX, yTarget);
      powerCircle.x = player2.shooter.x;
    }
    power = Math.abs(xStart - mouseX);
    if (power > 400) 
      power = 400;
    powerCircle.radius = power / 3;
  }
});

onMouseUp(() => {
  if (player1.turn) {
    setBall(player1);
    repeatUntil(() => makeContact(player1), () => {
      shoot(player1);
    }, () => {
      finishTurn(player1);
    });
  }
  else if (player2.turn) {
    setBall(player2);
    repeatUntil(() => makeContact(player2), () => {
      shoot(player2);
    }, () => {
      finishTurn(player2);
    });
  }
});

var powerText = new Text({
  text: () => "Power: " + power
});

var targetText = new Text({
  text: () => "Y Target: " + yTarget,
  y: - 20
});

</script>  
</body>